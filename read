#!/bin/sh

process () {
  read width height <<<$(getImageDimensions "in/$1")
  dWidth=$(($backgroundWidth - $width))
  dHeight=$(($backgroundHeight - $height))
  if [ "$dWidth" -lt 0 ] || [ "$dHeight" -lt 0 ]
  then
    error "background file too small"
  fi
  convert \( -size "$width"x"$height" xc:black \) \
    \( "$background" \
      -chop $(random $(($dWidth + 1)))x$(random $(($dHeight + 1))) \) \
    \( "in/$1" $(level) \) -composite test.png
}

getImageDimensions () {
  echo $(identify -verbose "$1" | \
    sed -En 's/^  Geometry: ([0-9]+)x([0-9]+)\+0\+0$/\1 \2/p')
}

random () {
  echo $(( \
    $(dd if=/dev/urandom count=1 2> /dev/null | cksum | cut -f1 -d" ") % $1))
}

level () {
  if [[ -n "$gamma" ]]
  then
    echo "-level 0%,100%,$gamma"
  fi
}

error () {
  echo "error: $1" 1>&2
  exit 1
}

while getopts "g:" OPTION
do
  case $OPTION in
    g) gamma=$OPTARG ;;
    \?) error "usage error" ;;
  esac
done

echo ${!OPTIND}
echo $(level)

if [ -f background.png ]
then
  background=background.png
fi

if [ -z "$background" ]
then
  error "no background file"
fi

read backgroundWidth backgroundHeight <<<$(getImageDimensions "$background")
echo $backgroundWidth
echo $backgroundHeight

#error handling?
ls in | while read file
do process "$file"
  
done


#check file count
